Django 02 Django Model
목차 • Model • ORM • Migrations • Database API • CRUD • Admin Site Model Confidential • 단일한 데이터에 대한 정보를 가짐 • 사용자가 저장하는 데이터들의 필수적인 필드들과 동작들을 포함 • 저장된 데이터베이스의 구조(layout)  • django는 model을 통해 데이터에 접속하고 관리 • 일반적으로 각각의 model은 하나의 데이터베이스 테이블에 매핑 됨 Model https://docs.djangoproject.com/en/3.2/topics/db/models/ Confidential • 데이터베이스(DB) • 체계화된 데이터의 모임 • 쿼리(Query) • 데이터를 조회하기 위한 명령어 • 조건에 맞는 데이터를 추출하거나 조작하는 명령어 • "Query를 날린다." → DB를 조작한다. Database Confidential • 스키마(Schema) • 데이터베이스에서 자료의 구조, 표현방법, 관계 등을 정의한 구조 (structure) • 테이블(Table) • 열(column) : 필드(field) or 속성 • 행(row) : 레코드(record) or 튜플 Database의 기본 구조 Confidential Database 의 기본 구조 Confidential Database 의 기본 구조 Confidential Database 의 기본 구조 Confidential Database 의 기본 구조 Confidential Database 의 기본 구조 Confidential • “웹 애플리케이션의 데이터를 구조화하고 조작하기 위한 도구” Model 정리 ORM Confidential • Object-Relational-Mapping • 객체 지향 프로그래밍 언어를 사용하여 호환되지 않는 유형의 시스템 간에(Django - SQL)데이터를 변환하는 프로그래밍 기술 • OOP 프로그래밍에서 RDBMS을 연동할 때, 데이터베이스와 객체 지향 프로그래밍 언어 간의 호환되지 않는 데이터를 변환하는 프로그래밍 기법 • Django는 내장 Django ORM을 사용함 ORM https://en.wikipedia.org/wiki/Object%E2%80%93relational_mapping Confidential ORM 예시 (1/2) Confidential ORM 예시 (2/2) Confidential • 장점 • SQL을 잘 알지 못해도 DB 조작이 가능 • SQL의 절차적 접근이 아닌 객체 지향적 접근으로 인한 높은 생산성 • 단점 • ORM 만으로 완전한 서비스를 구현하기 어려운 경우가 있음 • 현대 웹 프레임워크의 요점은 웹 개발의 속도를 높이는 것. (생산성) ORM의 장점과 단점 Confidential 왜 ORM을 사용할까? “우리는 DB를 객체(object)로 조작하기 위해 ORM을 사용한다.” Confidential • DB 컬럼과 어떠한 타입으로 정의할 것인지에 대해 django.db 라는 모듈의 models 를 상속 • 각 모델은 django.db.models.Model 클래스의 서브 클래스로 표현 • title과 content은 모델의 필드를 나타냄 • 각 필드는 클래스 속성으로 지정되어 있으며, 각 속성은 각 데이터베이스의 열에 매핑 models.py 작성 Confidential • CharField(max_length=None, **options) • 길이의 제한이 있는 문자열을 넣을 때 사용 • CharField의 max_length는 필수 인자 • 필드의 최대 길이(문자), 데이터베이스 레벨과 Django의 유효성 검사(값을 검증하는 것)에서 활용 사용 모델 필드 https://docs.djangoproject.com/en/3.2/ref/models/fields/#django.db.models.CharField Confidential • TextField(**options) • 글자의 수가 많을 때 사용 • max_length 옵션 작성시 자동 양식 필드인 textarea 위젯에 반영은 되지만 모델과 데이터베이스 수준에는 적용되지 않음 • max_length 사용은 CharField에서 사용해야 함 사용 모델 필드 https://docs.djangoproject.com/en/3.2/ref/models/fields/#django.db.models.TextField Migrations Confidential • “django가 model에 생긴 변화를 반영하는 방법” • Migration(이하 마이그레이션) 실행 및 DB 스키마를 다루기 위한 몇가지 명령어 • makemigrations • migrate • sqlmigrate • showmigrations Migrations https://docs.djangoproject.com/en/3.2/topics/migrations/ Confidential 1. makemigrations • model을 변경한 것에 기반한 새로운 마이그레이션(like 설계도)을 만들 때 사용 2. migrate • 마이그레이션을 DB에 반영하기 위해 사용 • 설계도를 실제 DB에 반영하는 과정 • 모델에서의 변경 사항들과 DB의 스키마가 동기화를 이룸 Migrations Commands - 1 Confidential 3. sqlmigrate • 마이그레이션에 대한 SQL 구문을 보기 위해 사용 • 마이그레이션이 SQL 문으로 어떻게 해석되어서 동작할지 미리 확인 할 수 있음 4. showmigrations • 프로젝트 전체의 마이그레이션 상태를 확인하기 위해 사용 • 마이그레이션 파일들이 migrate 됐는지 안됐는지 여부를 확인 할 수 있음 Migrations Commands - 2 Confidential 'migrations/0001_initial.py' 생성 확인 [실습] makemigrations Confidential 0001_initial.py 설계도를 실제 DB에 반영 [실습] migrate Confidential vscode sqlite 확장프로그램을 통해 확인 [실습] 실제 DB table 확인 Confidential 해당 migrations 설계도가 SQL 문으로 어떻게 해석되어서 동작할지 미리 확인 할 수 있음 [실습] sqlmigrate Confidential 실제 DB에 전달되는 SQL 문 [실습] sqlmigrate Confidential migrations 설계도들이 migrate 됐는지 안됐는지 여부를 확인 할 수 있음 [실습] showmigrations (1/2) Confidential showmigrations 결과 [실습] showmigrations (2/2) Confidential 추가 모델 필드 작성 후 makemigrations 진행 [실습] model 수정 (1/3) Confidential created_at 필드에 대한 default 값 설정 => 1 입력 후 enter  [실습] model 수정 (2/3) Confidential timezone.now 함수 값 자동 설정 빈 값 상태에서 enter 클릭 migrate를 통해 models.py 수정사항 반영 [실습] model 수정 (3/3) Confidential • auto_now_add • 최초 생성 일자 • django ORM이 최초 insert(테이블에 데이터 입력)시에만 현재 날짜와 시간으로 갱신 (테이블에 어떤 값을 최초로 넣을 때) • auto_now • 최종 수정 일자 • django ORM이 save를 할 때마다 현재 날짜와 시간으로 갱신 DateField’s options https://docs.djangoproject.com/en/3.2/ref/models/fields/#datefield Confidential 1. models.py • model 변경사항 발생 시 2. $ python manage.py makemigrations • migrations 파일 생성 3. $ python manage.py migrate • DB 반영 (모델과 DB의 동기화) 반드시 기억해야 할 migration 3단계 Database API Confidential • “DB를 조작하기 위한 도구” • django가 기본적으로 ORM을 제공함에 따른 것으로 DB를 편하게 조작할 수 있도록 도움 • Model을 만들면 django는 객체들을 만들고 읽고 수정하고 지울 수 있는 database-abstract API를 자동으로 만듦 • database-abstract API 혹은 database-access API 라고도 함 DB API https://docs.djangoproject.com/en/3.2/topics/db/queries/ Confidential DB API 구문 - Making Queries Article.objects.all() Class Name Manager QuerySet API Confidential • Manager • django 모델에 데이터베이스 query 작업이 제공되는 인터페이스 • 기본적으로 모든 django 모델 클래스에 objects라는 Manager를 추가 • QuerySet • 데이터베이스로부터 전달받은 객체 목록 • queryset 안의 객체는 0개, 1개 혹은 여러 개일 수 있음 • 데이터베이스로부터 조회, 필터, 정렬 등을 수행 할 수 있음 DB API Confidential • 일반 Python shell을 통해서는 장고 프로젝트 환경에 접근할 수 없음 • 그래서 장고 프로젝트 설정이 load 된 Python shell을 활용해 DB API 구문 테스트 진행 • 기본 Django shell 보다 더 많은 기능을 제공하는 shell_plus를 사용해서 진행 • Django-extensions 라이브러리의 기능 중 하나 Django shell Confidential More powerful interactive shell을 위한 2가지 라이브러리 설치 [실습] 라이브러리 설치 Confidential 앱 등록 후 shell_plus 실행 [실습] 라이브러리 등록 및 실행 (1/2) Confidential shell_plus 실행 화면 [실습] 라이브러리 등록 및 실행 (2/2) CRUD Confidential • 대부분의 컴퓨터 소프트웨어가 가지는 기본적인 데이터 처리 기능인 Create(생성), Read(읽기), Update(갱신), Delete(삭제)를 묶어서 일컫는 말 CRUD https://ko.wikipedia.org/wiki/CRUD Confidential 전체 article 객체 조회 [실습] READ Confidential CREATE 첫번째 방법 “인스턴스 생성 후 인스턴스 변수 설정” [실습] CREATE (1/3) Confidential CREATE 두번째 방법 “초기 값과 함께 인스턴스 생성” [실습] CREATE (2/3) Confidential CREATE 세번째 방법 “QuerySet API – create() 사용” [실습] CREATE (3/3) https://docs.djangoproject.com/en/3.2/ref/models/querysets/#create Confidential 실제로 저장이 되었는지 여부를 확인 [실습] 테이블 확인 Confidential • save() method • Saving objects • 객체를 데이터베이스에 저장함 • 데이터 생성 시 save()를 호출하기 전에는 객체의 ID 값이 무엇인지 알 수 없음 • ID 값은 django가 아니라 DB에서 계산되기 때문 • 단순히 모델을 인스턴스화 하는 것은 DB에 영향을 미치지 않기 때문에 반드시 save()가 필요 CREATE 관련 메서드 https://docs.djangoproject.com/en/3.2/ref/models/instances/#saving-objects Confidential 표준 파이썬 클래스의 메소드인 str() 을 정의하여 각각의 object가 사람이 읽을 수 있는 문자열을 반환(return)하도록 할 수 있음 작성 후 반드시 shell_plus를 재시작해야 반영됨 str method Confidential • QuerySet API method를 사용해 다양한 조회를 하는 것이 중요 • QuerySet API method는 크게 2가지로 분류 1. Methods that return new querysets 2. Methods that do not return querysets READ https://docs.djangoproject.com/en/3.2/ref/models/querysets/ Confidential • all() • 현재 QuerySet의 복사본을 반환 [실습] READ (1/3) https://docs.djangoproject.com/en/3.2/ref/models/querysets/#all Confidential • get() • 주어진 lookup 매개변수와 일치하는 객체를 반환 • 객체를 찾을 수 없으면 DoesNotExist 예외를 발생시키고, 둘 이상의 객체를 찾으면 MultipleObjectReturned 예외를 발생 시킴 • 위와 같은 특징을 가지고 있기 때문에 primary key와 같이 고유(unique)성을 보장하는 조회에서 사용해야 함 [실습] READ (2/3) https://docs.djangoproject.com/en/3.2/ref/models/querysets/#get Confidential • filter() • 주어진 lookup 매개변수와 일치하는 객체를 포함하는 새 QuerySet을 반환 [실습] READ (3/3) https://docs.djangoproject.com/en/3.2/ref/models/querysets/#filter Confidential article 인스턴스 객체의 인스턴스 변수의 값을 변경 후 저장 [실습] UPDATE Confidential • .delete() • QuerySet의 모든 행에 대해 SQL 삭제 쿼리를 수행하고, 삭제된 객체 수와 객체 유형당 삭제 수가 포함된 딕셔너리를 반환 [실습] DELETE https://docs.djangoproject.com/en/3.2/ref/models/querysets/#delete Confidential • 조회 시 특정 검색 조건을 지정 • QuerySet 메서드 filter(), exclude() 및 get()에 대한 키워드 인수로 지정됨 • 사용 예시) • Article.objects.filter(pk__gt=2) • Article.objects.filter(content__contains=‘ja’) Field lookups https://docs.djangoproject.com/en/3.2/ref/models/querysets/#field-lookups Confidential • 데이터베이스 조작을 위한 다양한 QuerySet API methods는 해당 공식문서를 반드시 참고하여 학습할 것 • https://docs.djangoproject.com/en/3.2/ref/models/querysets/#queryset-api-reference QuerySet API Admin Site Confidential • 사용자가 아닌 서버의 관리자가 활용하기 위한 페이지 • Model class를 admin.py에 등록하고 관리 • django.contrib.auth 모듈에서 제공됨 • record 생성 여부 확인에 매우 유용하며, 직접 record를 삽입할 수도 있음 Automatic admin interface  https://docs.djangoproject.com/en/3.2/ref/contrib/admin/#module-django.contrib.admin Confidential • 관리자 계정 생성 후 서버를 실행한 다음 ‘/admin’ 으로 가서 관리자 페이지 로그인 • 계정만 만든 경우 Django 관리자 화면에서 아무 것도 보이지 않음 • 내가 만든 record를 보기 위해서는 admin.py에 작성하여 Django 서버에 등록 • [주의] auth에 관련된 기본 테이블이 생성되지 않으면 관리자 계정을 생성할 수 없음 admin 생성 Confidential • admin.py는 관리자 사이트에 Article 객체가 관리자 인터페이스를 가지고 있다는 것을 알려주는 것 • models.py에 정의한 __str__의 형태로 객체가 표현됨 admin 등록 Confidential • list_display • models.py 정의한 각각의 속성(컬럼)들의 값(레코드)를 admin 페이지에 출력하도록 설정 ModelAdmin options (1/2) https://docs.djangoproject.com/en/3.2/ref/contrib/admin/#modeladmin-options Confidential • list_filter, list_display_links 등 다양한 ModelAdmin options 참고 • https://docs.djangoproject.com/en/3.2/ref/contrib/admin/#modeladmin-options ModelAdmin options (2/2) CRUD with views Confidential 1. 프로젝트 이름 • crud 2. 앱 이름 • articles 3. 앱 등록 CRUD 직접 작성해보기 Confidential base 템플릿 작성 및 추가 템플릿 경로 등록 Confidential index 페이지 작성 CRUD with views Confidential READ - 전체 게시글 조회 CRUD with views Confidential CREATE – New views CRUD with views Confidential CREATE – Create views Confidential 게시글 정렬 순서 변경 Confidential • GET • 특정 리소스를 가져오도록 요청할 때 사용 • 반드시 데이터를 가져올 때만 사용해야 함 • DB에 변화를 주지 않음 • CRUD에서 R 역할을 담당 HTTP method https://developer.mozilla.org/ko/docs/Web/HTTP/Methods/GET Confidential • POST • 서버로 데이터를 전송할 때 사용 • 리소스를 생성/변경하기 위해 데이터를 HTTP body에 담아 전송 • 서버에 변경사항을 만듦 • CRUD에서 C/U/D 역할을 담당 HTTP method https://developer.mozilla.org/ko/docs/Web/HTTP/Methods/POST Confidential • 웹 애플리케이션 취약점 중 하나로 사용자가 자신의 의지와 무관하게 공격자가 의도한 행동을 하여 특정 웹페이지를 보안에 취약하게 한다거나 수정, 삭제 등의 작업을 하게 만드는 공격 방법 • django는 CSRF에 대항하여 middleware와 template tag를 제공 • CSRF라고도 함 사이트 간 요청 위조 (Cross-site request forgery) https://en.wikipedia.org/wiki/Cross-site_request_forgery Confidential • Security Token 사용 방식 (CSRF Token) • 사용자의 데이터에 임의의 난수 값을 부여해, 매 요청마다 해당 난수 값을 포함시켜 전송 시키도록 함 • 이후 서버에서 요청을 받을 때마다 전달된 token 값이 유효한지 검증 • 일반적으로 데이터 변경이 가능한 POST, PATCH, DELETE Method 등에 적용 (GET 제외) • django는 csrf token 템플릿 태그를 제공 CSRF 공격 방어 Confidential • CSRF 보호에 사용 • input type이 hidden으로 작성되며 value는 django에서 생성한 hash 값으로 설정됨 • 해당 태그 없이 요청을 보낸다면 Django 서버는 403 forbidden을 응답 csrf_token template tag https://docs.djangoproject.com/en/3.2/ref/templates/builtins/#csrf-token Confidential • csrf 공격 관련 보안 설정은 settings.py에서 MIDDLEWARE에 작성 되어있음 • 실제로 요청 과정에서 urls.py 이전에 Middleware의 설정 사항들을 순차적으로 거치며 응답은 반대로 하단에서 상단으로 미들웨어를 적용시킴 CsrfViewMiddleware Confidential • 공통 서비스 및 기능을 애플리케이션에 제공하는 소프트웨어 • 데이터 관리, 애플리케이션 서비스, 메시징, 인증 및 API 관리를 주로 미들웨어를 통해 처리 • 개발자들이 애플리케이션을 보다 효율적으로 구축할 수 있도록 지원하며, 애플리케이션, 데이터 및 사용자 사이를 연결하는 요소처럼 작동 [참고] Middleware Confidential new 로직 수정 Confidential POST 데이터 확인 Confidential 게시글 작성 후 index 페이지로 이동하기. 하지만.. Confidential 1. 글을 작성 후 index 페이지가 출력되지만 게시글이 조회되지 않음 2. URL은 여전히 create에 머물러 있음 • 단순히 index 페이지만 render 되었을 뿐이고 url이 돌아가지 못했기 때문 2가지 문제 발생 Confidential • 새 URL로 되돌림 • 인자에 따라 HttpResponseRedirect를 반환 • 브라우저는 현재 경로에 따라 전체 URL 자체를 재구성(reconstruct) • 사용 가능한 인자 1. model 2. view name: viewname can be URL pattern name or callable view object. 3. absolute or relative URL Django shortcut function – “redirect()” https://docs.djangoproject.com/en/3.2/topics/http/shortcuts/#redirect Confidential redirect 함수 적용 Confidential • 개별 게시글 상세 페이지 • 글의 번호(pk)를 활용해서 각각의 페이지를 따로 구현해야 함 • 무엇을 활용할 수 있을까? →  DETAIL Confidential • 개별 게시글 상세 페이지 • 글의 번호(pk)를 활용해서 각각의 페이지를 따로 구현해야 함 • 무엇을 활용할 수 있을까? → Variable Routing DETAIL Confidential • 오른쪽 pk는 variable routing을 통해 받은 pk • 왼쪽 pk는 DB에 저장된 레코드의 pk (id) DETAIL Confidential • Detail 페이지 및 링크 작성 DETAIL Confidential • redirect 인자 변경 DETAIL CRUD with views Confidential DELETE - 모든 글을 삭제 하는 것이 아니라 삭제하고자 하는 특정 글을 삭제해야 함 Confidential HTTP Method POST 시에만 삭제 될 수 있도록 조건 작성 DELETE CRUD with views Confidential EDIT 수정은 기존에 입력 되어 있던 데이터를 보여주는것이 좋기 때문에 html 태그의 value 속성을 사용 (textarea 태그는 value 속성이 없으므로 태그 내부 값으로 작성) Confidential detail.html에 edit 링크 작성 EDIT CRUD with views Confidential UPDATE create와 마찬가지로 별도의 '글이 수정되었습니다' 라는 메시지를 출력하는 template는 필요하지 않음 마무리 마무리 • Model • 웹 애플리케이션의 데이터를 구조화하고 조작하기 위한 도구 • Database • 체계화 된 데이터의 모임(집합) • Migrations • django가 model에 생긴 변화 (필드를 추가했다던가 모델을 삭제했다던가 등)를 반영하는 방법 마무리 • ORM • OOP 언어를 사용하여 데이터베이스와 OOP 언어 간의 호환되지 않는 데이터를 변환하는 프로그래밍 기법 • Database API • DB를 조작하기 위한 도구 (QuerySet API, CRUD) • Admin Site • 사용자가 아닌 서버의 관리자가 활용하기 위한 페이지
